name: "Deploy Storybook with Chromatic"

on:
  pull_request:
    types: [opened, synchronize]
    # PRì— ì•„ë˜ íŒŒì¼ë“¤ì´ ë³€ê²½ë  ê²½ìš°ì—ë§Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
    paths:
      - "**/*.stories.ts"
      - "**/*.stories.tsx"
      - ".storybook/**"

jobs:
  chromatic:
    name: Run Chromatic
    runs-on: ubuntu-latest # ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # ì €ì¥ì†Œ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ
        with:
          fetch-depth: 0 # ì „ì²´ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜´ (Chromaticì˜ Git ê¸°ë°˜ ë¹„êµ ê¸°ëŠ¥ì„ ìœ„í•´ í•„ìš”)

      - uses: actions/setup-node@v4 # Node.js í™˜ê²½ ì„¤ì •
        with:
          node-version: 22.x # Node.js 22 ë²„ì „ ì‚¬ìš©

      - name: Install dependencies
        run: npm ci # package-lock.json ê¸°ì¤€ìœ¼ë¡œ ë¹ ë¥´ê³  ì¼ê´€ë˜ê²Œ ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ./frontend # frontend ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

      - name: Generate environment variables
        run: |
          echo "BASE_URL=${{ secrets.FE_BASE_URL }}" >> .env
        env:
          BASE_URL: ${{ secrets.FE_BASE_URL }}
        working-directory: ./frontend # frontend ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

      - name: Build Storybook
        run: npm run build-storybook # ì •ì  Storybook ì‚¬ì´íŠ¸ ë¹Œë“œ
        working-directory: ./frontend # frontend ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

      - name: Run Chromatic
        id: chromatic
        uses: chromaui/action@latest # Chromaticì— Storybook ë°°í¬
        with:
          projectToken: ${{ secrets.FE_CHROMATIC_PROJECT_TOKEN }} # Chromatic í”„ë¡œì íŠ¸ í† í° (GitHub Secretsì—ì„œ ê´€ë¦¬)
          token: ${{ secrets.GITHUB_TOKEN }} # GitHub ì¸ì¦ìš© í† í° (ê¸°ë³¸ ì œê³µ)
          workingDir: ./frontend # Chromaticë„ frontend ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2 # PRì— ìë™ìœ¼ë¡œ ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ëŠ” ì•¡ì…˜
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # PRì— ëŒ“ê¸€ì„ ë‹¬ê¸° ìœ„í•œ GitHub ì¸ì¦ í† í°
        with:
          message: "ğŸš€storybook: ${{ steps.chromatic.outputs.storybookUrl }}" # Chromaticì—ì„œ ìƒì„±ëœ Storybook ë°°í¬ ë§í¬ë¥¼ ì½”ë©˜íŠ¸ë¡œ ë‚¨ê¹€
